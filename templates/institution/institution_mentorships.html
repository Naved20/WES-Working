{% extends "base2.html" %}

{% block title %}Institution Mentorships{% endblock %}

{% block content %}
<div class="container">
    <div class="header-section">
        <h1>Institution Mentorships</h1>
        <p>Manage mentorship programs within {{ session.institution }}</p>
    </div>

    <!-- Statistics -->
    <div class="mentorship-stats">
        <div class="stat-item">
            <div class="stat-number">{{ mentorships|length }}</div>
            <div class="stat-label">Total Requests</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ mentorships|selectattr('final_status', 'equalto', 'approved')|list|length }}</div>
            <div class="stat-label">Approved</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ mentorships|selectattr('final_status', 'equalto', 'pending')|list|length }}</div>
            <div class="stat-label">Pending</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ mentorships|selectattr('final_status', 'equalto', 'rejected')|list|length }}</div>
            <div class="stat-label">Rejected</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-section">
        <div class="filter-group">
            <label for="statusFilter">Filter by Status:</label>
            <select id="statusFilter" class="filter-select">
                <option value="all">All Status</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="mentorFilter">Filter by Mentor:</label>
            <select id="mentorFilter" class="filter-select">
                <option value="all">All Mentors</option>
                {% for mentorship in mentorships %}
                    <option value="{{ mentorship.mentor.name }}">{{ mentorship.mentor.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Mentorships Table -->
    <div class="mentorships-table">
        {% if mentorships %}
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Mentee</th>
                    <th>Mentor</th>
                    <th>Purpose</th>
                    <th>Duration</th>
                    <th>Mentor Status</th>
                    <th>Supervisor Status</th>
                    <th>Final Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for mentorship in mentorships %}
                <tr class="mentorship-row" data-status="{{ mentorship.final_status }}" data-mentor="{{ mentorship.mentor.name }}">
                    <td>#{{ mentorship.id }}</td>
                    <td>
                        <div class="user-info">
                            <strong>{{ mentorship.mentee.name }}</strong>
                            <small>{{ mentorship.mentee.email }}</small>
                        </div>
                    </td>
                    <td>
                        <div class="user-info">
                            <strong>{{ mentorship.mentor.name }}</strong>
                            <small>{{ mentorship.mentor.email }}</small>
                        </div>
                    </td>
                    <td>{{ mentorship.purpose }}</td>
                    <td>{{ mentorship.duration_months }} months</td>
                    <td>
                        <span class="status-badge status-{{ mentorship.mentor_status }}">
                            {{ mentorship.mentor_status }}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge status-{{ mentorship.supervisor_status }}">
                            {{ mentorship.supervisor_status }}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge status-{{ mentorship.final_status }}">
                            {{ mentorship.final_status }}
                        </span>
                    </td>
                    <td>{{ mentorship.created_at.strftime('%d %b %Y') }}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-view" onclick="viewMentorshipDetails({{ mentorship.id }})">
                                View
                            </button>
                            {% if mentorship.final_status == 'pending' %}
                            <button class="btn-approve" onclick="approveMentorship({{ mentorship.id }})">
                                Approve
                            </button>
                            <button class="btn-reject" onclick="rejectMentorship({{ mentorship.id }})">
                                Reject
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="no-data">
            <div class="no-data-icon">ü§ù</div>
            <h3>No Mentorships Found</h3>
            <p>There are no mentorship requests from your institution yet.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
function viewMentorshipDetails(mentorshipId) {
    // Implement view mentorship details
    alert('View mentorship details: ' + mentorshipId);
    // window.location.href = `/mentorship_details/${mentorshipId}`;
}

function approveMentorship(mentorshipId) {
    if (confirm('Are you sure you want to approve this mentorship request?')) {
        // Implement approval logic
        fetch(`/supervisor_response`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `request_id=${mentorshipId}&action=approve`
        }).then(response => {
            if (response.ok) {
                location.reload();
            }
        });
    }
}

function rejectMentorship(mentorshipId) {
    if (confirm('Are you sure you want to reject this mentorship request?')) {
        // Implement rejection logic
        fetch(`/supervisor_response`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `request_id=${mentorshipId}&action=reject`
        }).then(response => {
            if (response.ok) {
                location.reload();
            }
        });
    }
}

// Filter functionality
document.getElementById('statusFilter').addEventListener('change', filterMentorships);
document.getElementById('mentorFilter').addEventListener('change', filterMentorships);

function filterMentorships() {
    const statusFilter = document.getElementById('statusFilter').value;
    const mentorFilter = document.getElementById('mentorFilter').value;
    
    const rows = document.querySelectorAll('.mentorship-row');
    
    rows.forEach(row => {
        const status = row.getAttribute('data-status');
        const mentor = row.getAttribute('data-mentor');
        
        const matchesStatus = statusFilter === 'all' || status === statusFilter;
        const matchesMentor = mentorFilter === 'all' || mentor === mentorFilter;
        
        if (matchesStatus && matchesMentor) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}
</script>

<style>
.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.header-section {
    text-align: center;
    margin-bottom: 30px;
}

.header-section h1 {
    color: #333;
    margin-bottom: 10px;
}

.header-section p {
    color: #666;
    font-size: 1.1em;
}

.mentorship-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
}

.stat-item {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
}

.stat-number {
    font-size: 2em;
    font-weight: bold;
    color: #007bff;
    margin-bottom: 5px;
}

.stat-label {
    color: #666;
    font-size: 0.9em;
}

.filters-section {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.filter-group label {
    font-weight: bold;
    color: #333;
}

.filter-select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background: white;
    min-width: 150px;
}

.mentorships-table {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
}

table {
    width: 100%;
    border-collapse: collapse;
}

thead {
    background: #f8f9fa;
}

th {
    padding: 15px;
    text-align: left;
    font-weight: bold;
    color: #333;
    border-bottom: 2px solid #dee2e6;
}

td {
    padding: 15px;
    border-bottom: 1px solid #dee2e6;
}

.mentorship-row:hover {
    background: #f8f9fa;
}

.user-info {
    display: flex;
    flex-direction: column;
}

.user-info strong {
    color: #333;
}

.user-info small {
    color: #666;
    font-size: 0.8em;
}

.status-badge {
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.8em;
    font-weight: bold;
    text-transform: capitalize;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.status-approved {
    background: #d4edda;
    color: #155724;
}

.status-rejected {
    background: #f8d7da;
    color: #721c24;
}

.action-buttons {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}

.btn-view, .btn-approve, .btn-reject {
    padding: 5px 10px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.8em;
    transition: background 0.3s ease;
}

.btn-view {
    background: #6c757d;
    color: white;
}

.btn-view:hover {
    background: #545b62;
}

.btn-approve {
    background: #28a745;
    color: white;
}

.btn-approve:hover {
    background: #218838;
}

.btn-reject {
    background: #dc3545;
    color: white;
}

.btn-reject:hover {
    background: #c82333;
}

.no-data {
    text-align: center;
    padding: 60px 20px;
}

.no-data-icon {
    font-size: 4em;
    margin-bottom: 20px;
}

.no-data h3 {
    color: #666;
    margin-bottom: 10px;
}

.no-data p {
    color: #999;
}

@media (max-width: 768px) {
    .mentorships-table {
        overflow-x: auto;
    }
    
    table {
        min-width: 800px;
    }
    
    .filters-section {
        flex-direction: column;
    }
    
    .action-buttons {
        flex-direction: column;
    }
}
</style>
{% endblock %}