{% extends "base2.html" %}
{% block title %}Mentee Calendar{% endblock %}
{% block user %}Mentee{% endblock %}
{% block profiledrop %}{% endblock %}
{% block content %}

<style>
  .nav-btn {
    background: transparent;
    color: #6b7280;
  }
  
  .nav-btn.active, .nav-btn:hover {
    background: white;
    color: #111827;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  .calendar-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }
  
  .calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #e5e7eb;
  }
  
  .calendar-navigation button {
    background: #f3f4f6;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    margin: 0 5px;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .calendar-navigation button:hover {
    background: #e5e7eb;
  }
  
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: #e5e7eb;
  }
  
  .calendar-day-header {
    background: #f9fafb;
    padding: 12px;
    text-align: center;
    font-weight: 600;
    color: #374151;
  }
  
  .calendar-day {
    background: white;
    min-height: 120px;
    padding: 8px;
    position: relative;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .calendar-day:hover {
    background: #f9fafb;
  }
  
  .calendar-day.other-month {
    background: #f9fafb;
    color: #9ca3af;
  }
  
  .calendar-day.today {
    background: #eff6ff;
  }
  
  .day-number {
    font-weight: 600;
    margin-bottom: 4px;
  }
  
  .event {
    background: #8b5cf6;
    color: white;
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 12px;
    margin-bottom: 2px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    cursor: pointer;
  }
  
  .event.upcoming {
    background: #3b82f6;
  }
  
  .event.completed {
    background: #10b981;
  }
  

  .event-details-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }
  
  .event-details-content {
    background: white;
    border-radius: 12px;
    padding: 24px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
  }
  
  .filter-options {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  
  .filter-btn {
    padding: 6px 12px;
    border-radius: 20px;
    border: 1px solid #d1d5db;
    background: white;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .filter-btn.active {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
  }
  
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #6b7280;
  }
  
  .empty-state svg {
    margin: 0 auto 16px;
    color: #d1d5db;
  }
</style>

<!-- Main Content Container -->
<main class="max-w-7xl mx-auto px-2 sm:px-3 lg:px-3 py-2">
  
  <!-- Calendar Section -->
  <section id="calendar" class="p-6 bg-white rounded-xl shadow-sm">
    <div class="mb-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-2">My Mentorship Calendar</h2>
      <p class="text-gray-600">View and manage your scheduled sessions with mentors.</p>
    </div>
    
    <!-- Filter Options -->
    <div class="filter-options">
      <button class="filter-btn active" data-type="all">All Sessions</button>
      <button class="filter-btn" data-type="upcoming">Upcoming</button>
      <button class="filter-btn" data-type="completed">Completed</button>
    </div>
    
    <!-- Calendar Container -->
    <div class="calendar-container">
      <div class="calendar-header">
        <h3 id="current-month-year" class="text-lg font-semibold">January 2023</h3>
        <div class="calendar-navigation">
          <button id="prev-month">&lt; Previous</button>
          <button id="today-btn">Today</button>
          <button id="next-month">Next &gt;</button>
        </div>
      </div>
      
      <div class="calendar-grid">
        <!-- Day headers -->
        <div class="calendar-day-header">Sun</div>
        <div class="calendar-day-header">Mon</div>
        <div class="calendar-day-header">Tue</div>
        <div class="calendar-day-header">Wed</div>
        <div class="calendar-day-header">Thu</div>
        <div class="calendar-day-header">Fri</div>
        <div class="calendar-day-header">Sat</div>
        
        <!-- Days will be populated by JavaScript -->
        <div id="calendar-days" class="col-span-7 grid grid-cols-7 gap-1 bg-gray-200">
          <!-- Calendar days will be inserted here by JavaScript -->
        </div>
      </div>
    </div>
    
    <!-- Legend -->
    <div class="mt-6 flex flex-wrap gap-4 text-sm">
      <div class="flex items-center">
        <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
        <span>Upcoming Sessions</span>
      </div>
      <div class="flex items-center">
        <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
        <span>Completed Sessions</span>
      </div>


    </div>
    
    <!-- Quick Actions -->
    <div class="mt-8 p-4 bg-blue-50 rounded-lg">
      <h3 class="font-medium text-blue-800 mb-2">Quick Actions</h3>
      <div class="flex flex-wrap gap-3">
        <a href="{{ url_for('find_mentor') }}" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition">
          Find a Mentor
        </a>
        <a href="{{ url_for('my_mentors') }}" class="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-700 transition">
          View My Mentors
        </a>
        <a href="{{ url_for('mentee_meeting_details') }}" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700 transition">
          View Meeting Details
        </a>
      </div>
    </div>
  </section>
</main>

<!-- Event Details Modal -->
<div id="event-details-modal" class="event-details-modal">
  <div class="event-details-content">
    <h3 class="text-xl font-semibold mb-4" id="event-title">Session Details</h3>
    <div class="space-y-3">
      <div>
        <span class="font-medium">Mentor:</span>
        <span id="event-mentor">Dr. Sarah Johnson</span>
      </div>
      <div>
        <span class="font-medium">Date & Time:</span>
        <span id="event-datetime">January 15, 2023 at 2:00 PM</span>
      </div>
      <div>
        <span class="font-medium">Duration:</span>
        <span id="event-duration">60 minutes</span>
      </div>
      <div>
        <span class="font-medium">Meeting Type:</span>
        <span id="event-type">Video Call</span>
      </div>
      <div>
        <span class="font-medium">Status:</span>
        <span id="event-status" class="px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Scheduled</span>
      </div>
      <div>
        <span class="font-medium">Agenda:</span>
        <p id="event-description" class="mt-1">Discussion about career options and guidance for next steps.</p>
      </div>
    </div>
    <div class="mt-6 flex justify-end space-x-3">
      <button id="close-event-modal" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Close</button>
      <button id="join-meeting-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Join Meeting</button>
      <button id="reschedule-btn" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition">Reschedule</button>
      <button id="cancel-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Cancel Session</button>
    </div>
  </div>
</div>

<script>
// Calendar data and functionality
let currentDate = new Date();
let events = [];
let currentFilter = 'all';

// Initialize events from database data passed via Jinja
function initializeEvents() {
  // Convert Python datetime objects to JavaScript Date objects
  events = [
    {% for meeting in meetings %}
    {
      id: {{ meeting.id }},
      title: "{{ meeting.title }}",
      date: new Date("{{ meeting.date.strftime('%Y-%m-%dT%H:%M:%S') }}"),
      duration: {{ meeting.duration }},
      mentor: "{{ meeting.mentor }}",
      type: "{{ meeting.type }}",
      status: "{{ meeting.status }}",
      description: "{{ meeting.description }}",
      meet_link: "{{ meeting.meet_link or '' }}"
    }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];
  
  // If no meetings from database, show empty state
  if (events.length === 0) {
    console.log("No meetings found in database");
  }
}

// Filter events based on current filter
function getFilteredEvents() {
  if (currentFilter === 'all') {
    return events;
  }
  return events.filter(event => event.status === currentFilter);
}

// Calendar rendering functions
function renderCalendar() {
  const calendarDays = document.getElementById('calendar-days');
  calendarDays.innerHTML = '';
  
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  
  // Update month/year display
  document.getElementById('current-month-year').textContent = 
    currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
  
  // Get first day of month and number of days in month
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const daysInMonth = lastDay.getDate();
  
  // Day of week for first day (0 = Sunday, 6 = Saturday)
  const startingDay = firstDay.getDay();
  
  // Days from previous month to show
  const prevMonthLastDay = new Date(year, month, 0).getDate();
  
  // Render days from previous month
  for (let i = 0; i < startingDay; i++) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day other-month';
    dayElement.innerHTML = `<div class="day-number">${prevMonthLastDay - startingDay + i + 1}</div>`;
    calendarDays.appendChild(dayElement);
  }
  
  // Render days of current month
  const today = new Date();
  const filteredEvents = getFilteredEvents();
  
  for (let i = 1; i <= daysInMonth; i++) {
    const dayElement = document.createElement('div');
    const dayDate = new Date(year, month, i);
    
    // Check if this is today
    const isToday = today.getDate() === i && 
                    today.getMonth() === month && 
                    today.getFullYear() === year;
    
    dayElement.className = `calendar-day ${isToday ? 'today' : ''}`;
    dayElement.innerHTML = `<div class="day-number">${i}</div>`;
    
    // Add events for this day
    const dayEvents = filteredEvents.filter(event => {
      const eventDate = new Date(event.date);
      return eventDate.getDate() === i && 
             eventDate.getMonth() === month && 
             eventDate.getFullYear() === year;
    });
    
    dayEvents.forEach(event => {
      const eventElement = document.createElement('div');
      eventElement.className = `event ${event.status}`;
      eventElement.textContent = `${event.date.getHours()}:${event.date.getMinutes().toString().padStart(2, '0')} - ${event.title}`;
      eventElement.addEventListener('click', () => showEventDetails(event));
      dayElement.appendChild(eventElement);
    });
    
    // Show empty state if no events after filtering
    if (currentFilter !== 'all' && dayEvents.length === 0) {
      dayElement.style.opacity = '0.5';
    }
    
    calendarDays.appendChild(dayElement);
  }
  
  // Calculate how many cells we've used so far
  const cellsUsed = startingDay + daysInMonth;
  const totalCells = Math.ceil(cellsUsed / 7) * 7;
  const nextMonthDays = totalCells - cellsUsed;
  
  // Render days from next month
  for (let i = 1; i <= nextMonthDays; i++) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day other-month';
    dayElement.innerHTML = `<div class="day-number">${i}</div>`;
    calendarDays.appendChild(dayElement);
  }
  
  // Show empty state if no events match the filter
  if (filteredEvents.length === 0 && currentFilter !== 'all') {
    const emptyState = document.createElement('div');
    emptyState.className = 'col-span-7 empty-state';
    emptyState.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>
      <p>No ${currentFilter} sessions found for this month.</p>
    `;
    calendarDays.appendChild(emptyState);
  }
}

function showEventDetails(event) {
  const modal = document.getElementById('event-details-modal');
  const eventDate = new Date(event.date);
  
  document.getElementById('event-title').textContent = event.title;
  document.getElementById('event-mentor').textContent = event.mentor;
  document.getElementById('event-datetime').textContent = 
    `${eventDate.toLocaleDateString()} at ${eventDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
  document.getElementById('event-duration').textContent = `${event.duration} minutes`;
  document.getElementById('event-type').textContent = event.type;
  document.getElementById('event-status').textContent = event.status.charAt(0).toUpperCase() + event.status.slice(1);
  document.getElementById('event-description').textContent = event.description;
  
  // Update status color
  const statusElement = document.getElementById('event-status');
  statusElement.className = 'px-2 py-1 rounded-full text-xs font-medium';
  if (event.status === 'upcoming') {
    statusElement.classList.add('bg-blue-100', 'text-blue-800');
  } else if (event.status === 'completed') {
    statusElement.classList.add('bg-green-100', 'text-green-800');
  }
  
  // Show/hide buttons based on event status
  const joinBtn = document.getElementById('join-meeting-btn');
  const rescheduleBtn = document.getElementById('reschedule-btn');
  const cancelBtn = document.getElementById('cancel-btn');
  
  if (event.status === 'upcoming') {
    joinBtn.style.display = 'inline-block';
    rescheduleBtn.style.display = 'inline-block';
    cancelBtn.style.display = 'inline-block';
    
    // Show join button only if meeting link exists and meeting is in the future
    if (event.meet_link && eventDate > new Date()) {
      joinBtn.style.display = 'inline-block';
      joinBtn.onclick = function() {
        window.open(event.meet_link, '_blank');
      };
    } else {
      joinBtn.style.display = 'none';
    }
  } else {
    joinBtn.style.display = 'none';
    rescheduleBtn.style.display = 'none';
    cancelBtn.style.display = 'none';
  }
  
  modal.style.display = 'flex';
}

function filterEvents(type) {
  currentFilter = type;
  renderCalendar();
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
  initializeEvents();
  renderCalendar();
  
  // Navigation buttons
  document.getElementById('prev-month').addEventListener('click', function() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
  });
  
  document.getElementById('next-month').addEventListener('click', function() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
  });
  
  document.getElementById('today-btn').addEventListener('click', function() {
    currentDate = new Date();
    renderCalendar();
  });
  
  // Filter buttons
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      filterEvents(this.dataset.type);
    });
  });
  
  // Modal close button
  document.getElementById('close-event-modal').addEventListener('click', function() {
    document.getElementById('event-details-modal').style.display = 'none';
  });
  
  // Reschedule button
  document.getElementById('reschedule-btn').addEventListener('click', function() {
    alert('This would open a rescheduling dialog in a real application');
  });
  
  // Cancel button
  document.getElementById('cancel-btn').addEventListener('click', function() {
    if (confirm('Are you sure you want to cancel this session?')) {
      alert('Session cancelled. This would update the database in a real application');
      document.getElementById('event-details-modal').style.display = 'none';
      // In a real app, we would update the event status and re-render
    }
  });
  
  // Close modal when clicking outside
  document.getElementById('event-details-modal').addEventListener('click', function(e) {
    if (e.target === this) {
      this.style.display = 'none';
    }
  });
});
</script>

{% endblock %}