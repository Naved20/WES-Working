{% extends "base2.html" %}
{% block title %}Create Meeting Request{% endblock %}
{% block user %}Mentee{% endblock %}
{% block profiledrop %}{% endblock %}

{% block content %}
<main class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
  <!-- Page Header -->
  <div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-900 font-poppins">Schedule Meeting</h2>
    <p class="text-gray-600 mt-1">Create a Google Meet session with your mentor</p>
  </div>

  <!-- Meeting Card -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    {% if mentor %}
      <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
        <div class="flex items-center gap-3">
          <div class="icon-container icon-container-blue w-10 h-10">
            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
          </div>
          <div>
            <p class="text-sm text-blue-600 font-medium">Meeting with</p>
            <p class="font-semibold text-gray-900">{{ mentor.name }}</p>
            <p class="text-sm text-gray-600">{{ mentor.email }}</p>
          </div>
        </div>
      </div>
      <input type="hidden" id="mentor_id" value="{{ mentor.id }}">
    {% else %}
      <div class="mb-6 p-4 bg-red-50 rounded-lg border border-red-200">
        <p class="text-red-600 font-medium">âš  No mentor selected!</p>
      </div>
    {% endif %}

    <div class="space-y-4">
      <div>
        <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Meeting Title</label>
        <input type="text" id="title" placeholder="e.g., Career Guidance Session" required
          class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
          <input type="date" id="date" required
            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
        </div>

        <div>
          <label for="start_time" class="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
          <input type="time" id="start_time" required
            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
        </div>
      </div>

      <div>
        <label for="duration" class="block text-sm font-medium text-gray-700 mb-1">Duration</label>
        <select id="duration" required
          class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
          <option value="">Select Duration</option>
          <option value="15">15 minutes</option>
          <option value="30">30 minutes</option>
          <option value="45">45 minutes</option>
          <option value="60">1 hour</option>
        </select>
      </div>

      <div>
        <label for="timezone" class="block text-sm font-medium text-gray-700 mb-1">Time Zone</label>
        <select id="timezone" required
          class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
    <option value="">Select Time Zone</option>
    
    <!-- Africa -->
    <optgroup label="Africa">
      <option value="Africa/Abidjan">Abidjan (GMT - UTC+0)</option>
      <option value="Africa/Accra">Accra (GMT - UTC+0)</option>
      <option value="Africa/Addis_Ababa">Addis Ababa (EAT - UTC+3)</option>
      <option value="Africa/Algiers">Algiers (CET - UTC+1)</option>
      <option value="Africa/Cairo">Cairo (EET - UTC+2)</option>
      <option value="Africa/Casablanca">Casablanca (WET - UTC+0/+1)</option>
      <option value="Africa/Johannesburg">Johannesburg (SAST - UTC+2)</option>
      <option value="Africa/Lagos">Lagos (WAT - UTC+1)</option>
      <option value="Africa/Nairobi">Nairobi (EAT - UTC+3)</option>
      <option value="Africa/Tunis">Tunis (CET - UTC+1)</option>
    </optgroup>
    
    <!-- Americas -->
    <optgroup label="Americas - North America">
      <option value="America/Anchorage">Anchorage (AKST/AKDT - UTC-9/-8)</option>
      <option value="America/Chicago">Chicago (CST/CDT - UTC-6/-5)</option>
      <option value="America/Denver">Denver (MST/MDT - UTC-7/-6)</option>
      <option value="America/Detroit">Detroit (EST/EDT - UTC-5/-4)</option>
      <option value="America/Halifax">Halifax (AST/ADT - UTC-4/-3)</option>
      <option value="America/Los_Angeles">Los Angeles (PST/PDT - UTC-8/-7)</option>
      <option value="America/Mexico_City">Mexico City (CST/CDT - UTC-6/-5)</option>
      <option value="America/New_York">New York (EST/EDT - UTC-5/-4)</option>
      <option value="America/Phoenix">Phoenix (MST - UTC-7)</option>
      <option value="America/Toronto">Toronto (EST/EDT - UTC-5/-4)</option>
      <option value="America/Vancouver">Vancouver (PST/PDT - UTC-8/-7)</option>
    </optgroup>
    
    <optgroup label="Americas - Central America">
      <option value="America/Belize">Belize (CST - UTC-6)</option>
      <option value="America/Costa_Rica">Costa Rica (CST - UTC-6)</option>
      <option value="America/Guatemala">Guatemala (CST - UTC-6)</option>
      <option value="America/Havana">Havana (CST/CDT - UTC-5/-4)</option>
      <option value="America/Panama">Panama (EST - UTC-5)</option>
    </optgroup>
    
    <optgroup label="Americas - South America">
      <option value="America/Bogota">Bogota (COT - UTC-5)</option>
      <option value="America/Buenos_Aires">Buenos Aires (ART - UTC-3)</option>
      <option value="America/Caracas">Caracas (VET - UTC-4)</option>
      <option value="America/Lima">Lima (PET - UTC-5)</option>
      <option value="America/Santiago">Santiago (CLT/CLST - UTC-4/-3)</option>
      <option value="America/Sao_Paulo">SÃ£o Paulo (BRT/BRST - UTC-3/-2)</option>
    </optgroup>
    
    <!-- Asia -->
    <optgroup label="Asia - Middle East">
      <option value="Asia/Amman">Amman (EET/EEST - UTC+2/+3)</option>
      <option value="Asia/Baghdad">Baghdad (AST - UTC+3)</option>
      <option value="Asia/Beirut">Beirut (EET/EEST - UTC+2/+3)</option>
      <option value="Asia/Damascus">Damascus (EET/EEST - UTC+2/+3)</option>
      <option value="Asia/Dubai">Dubai (GST - UTC+4)</option>
      <option value="Asia/Jerusalem">Jerusalem (IST/IDT - UTC+2/+3)</option>
      <option value="Asia/Kuwait">Kuwait (AST - UTC+3)</option>
      <option value="Asia/Riyadh">Riyadh (AST - UTC+3)</option>
      <option value="Asia/Tehran">Tehran (IRST/IRDT - UTC+3:30/+4:30)</option>
    </optgroup>
    
    <optgroup label="Asia - Central Asia">
      <option value="Asia/Almaty">Almaty (ALMT - UTC+6)</option>
      <option value="Asia/Ashgabat">Ashgabat (TMT - UTC+5)</option>
      <option value="Asia/Baku">Baku (AZT - UTC+4)</option>
      <option value="Asia/Kabul">Kabul (AFT - UTC+4:30)</option>
      <option value="Asia/Karachi">Karachi (PKT - UTC+5)</option>
      <option value="Asia/Tashkent">Tashkent (UZT - UTC+5)</option>
      <option value="Asia/Yerevan">Yerevan (AMT - UTC+4)</option>
    </optgroup>
    
    <optgroup label="Asia - South Asia">
      <option value="Asia/Colombo">Colombo (IST - UTC+5:30)</option>
      <option value="Asia/Dhaka">Dhaka (BST - UTC+6)</option>
      <option value="Asia/Kathmandu">Kathmandu (NPT - UTC+5:45)</option>
      <option value="Asia/Kolkata">Kolkata/India (IST - UTC+5:30)</option>
    </optgroup>
    
    <optgroup label="Asia - Southeast Asia">
      <option value="Asia/Bangkok">Bangkok (ICT - UTC+7)</option>
      <option value="Asia/Ho_Chi_Minh">Ho Chi Minh (ICT - UTC+7)</option>
      <option value="Asia/Jakarta">Jakarta (WIB - UTC+7)</option>
      <option value="Asia/Kuala_Lumpur">Kuala Lumpur (MYT - UTC+8)</option>
      <option value="Asia/Manila">Manila (PST - UTC+8)</option>
      <option value="Asia/Singapore">Singapore (SGT - UTC+8)</option>
      <option value="Asia/Yangon">Yangon (MMT - UTC+6:30)</option>
    </optgroup>
    
    <optgroup label="Asia - East Asia">
      <option value="Asia/Hong_Kong">Hong Kong (HKT - UTC+8)</option>
      <option value="Asia/Seoul">Seoul (KST - UTC+9)</option>
      <option value="Asia/Shanghai">Shanghai (CST - UTC+8)</option>
      <option value="Asia/Taipei">Taipei (CST - UTC+8)</option>
      <option value="Asia/Tokyo">Tokyo (JST - UTC+9)</option>
    </optgroup>
    
    <!-- Europe -->
    <optgroup label="Europe - Western Europe">
      <option value="Europe/Dublin">Dublin (GMT/IST - UTC+0/+1)</option>
      <option value="Europe/Lisbon">Lisbon (WET/WEST - UTC+0/+1)</option>
      <option value="Europe/London">London (GMT/BST - UTC+0/+1)</option>
    </optgroup>
    
    <optgroup label="Europe - Central Europe">
      <option value="Europe/Amsterdam">Amsterdam (CET/CEST - UTC+1/+2)</option>
      <option value="Europe/Berlin">Berlin (CET/CEST - UTC+1/+2)</option>
      <option value="Europe/Brussels">Brussels (CET/CEST - UTC+1/+2)</option>
      <option value="Europe/Budapest">Budapest (CET/CEST - UTC+1/+2)</option>
      <option value="Europe/Copenhagen">Copenhagen (CET/CEST - UTC+1/+2)</option>
      <option value="Europe/Luxembourg">Luxembourg (CET/CEST - UTC+1/+2)</option>
      <option value="Europe/Madrid">Madrid (CET/CEST - UTC+1/+2)</option>
      <option value="Europe/Oslo">Oslo (CET/CEST - UTC+1/+2)</option>
      <option value="Europe/Paris">Paris (CET/CEST - UTC+1/+2)</option>
      <option value="Europe/Prague">Prague (CET/CEST - UTC+1/+2)</option>
      <option value="Europe/Rome">Rome (CET/CEST - UTC+1/+2)</option>
      <option value="Europe/Stockholm">Stockholm (CET/CEST - UTC+1/+2)</option>
      <option value="Europe/Vienna">Vienna (CET/CEST - UTC+1/+2)</option>
      <option value="Europe/Warsaw">Warsaw (CET/CEST - UTC+1/+2)</option>
      <option value="Europe/Zurich">Zurich (CET/CEST - UTC+1/+2)</option>
    </optgroup>
    
    <optgroup label="Europe - Eastern Europe">
      <option value="Europe/Athens">Athens (EET/EEST - UTC+2/+3)</option>
      <option value="Europe/Bucharest">Bucharest (EET/EEST - UTC+2/+3)</option>
      <option value="Europe/Helsinki">Helsinki (EET/EEST - UTC+2/+3)</option>
      <option value="Europe/Istanbul">Istanbul (TRT - UTC+3)</option>
      <option value="Europe/Kiev">Kiev (EET/EEST - UTC+2/+3)</option>
      <option value="Europe/Moscow">Moscow (MSK - UTC+3)</option>
      <option value="Europe/Riga">Riga (EET/EEST - UTC+2/+3)</option>
      <option value="Europe/Sofia">Sofia (EET/EEST - UTC+2/+3)</option>
      <option value="Europe/Tallinn">Tallinn (EET/EEST - UTC+2/+3)</option>
      <option value="Europe/Vilnius">Vilnius (EET/EEST - UTC+2/+3)</option>
    </optgroup>
    
    <!-- Pacific -->
    <optgroup label="Pacific - Australia & New Zealand">
      <option value="Australia/Adelaide">Adelaide (ACST/ACDT - UTC+9:30/+10:30)</option>
      <option value="Australia/Brisbane">Brisbane (AEST - UTC+10)</option>
      <option value="Australia/Darwin">Darwin (ACST - UTC+9:30)</option>
      <option value="Australia/Melbourne">Melbourne (AEST/AEDT - UTC+10/+11)</option>
      <option value="Australia/Perth">Perth (AWST - UTC+8)</option>
      <option value="Australia/Sydney">Sydney (AEST/AEDT - UTC+10/+11)</option>
      <option value="Pacific/Auckland">Auckland (NZST/NZDT - UTC+12/+13)</option>
      <option value="Pacific/Fiji">Fiji (FJT/FJST - UTC+12/+13)</option>
    </optgroup>
    
    <optgroup label="Pacific - Pacific Islands">
      <option value="Pacific/Guam">Guam (ChST - UTC+10)</option>
      <option value="Pacific/Honolulu">Honolulu (HST - UTC-10)</option>
      <option value="Pacific/Pago_Pago">Pago Pago (SST - UTC-11)</option>
      <option value="Pacific/Port_Moresby">Port Moresby (PGT - UTC+10)</option>
      <option value="Pacific/Tahiti">Tahiti (TAHT - UTC-10)</option>
      <option value="Pacific/Tongatapu">Tongatapu (TOT - UTC+13)</option>
    </optgroup>
    
    <!-- Atlantic -->
    <optgroup label="Atlantic">
      <option value="Atlantic/Azores">Azores (AZOT/AZOST - UTC-1/+0)</option>
      <option value="Atlantic/Bermuda">Bermuda (AST/ADT - UTC-4/-3)</option>
      <option value="Atlantic/Cape_Verde">Cape Verde (CVT - UTC-1)</option>
      <option value="Atlantic/Reykjavik">Reykjavik (GMT - UTC+0)</option>
    </optgroup>
    
    <!-- Other -->
    <optgroup label="Other">
      <option value="UTC">UTC (Coordinated Universal Time)</option>
    </optgroup>
        </select>
      </div>

      <button onclick="createMeeting()" 
        class="w-full px-6 py-3 gradient-primary text-white font-medium rounded-lg hover:opacity-90 transition-all flex items-center justify-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
        </svg>
        Create Meeting
      </button>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
async function createMeeting() {
  const title = document.getElementById("title").value.trim();
  const date = document.getElementById("date").value;
  const start_time = document.getElementById("start_time").value;
  const duration = document.getElementById("duration").value;
  const timezone = document.getElementById("timezone").value;
  const mentor_id = document.getElementById("mentor_id").value;

  if (!title || !date || !start_time || !duration || !timezone) {
    Swal.fire("Error", "Please fill all fields including time zone!", "error");
    return;
  }

  // âœ… Validate that meeting date/time is in the future
  const meetingDateTime = new Date(`${date}T${start_time}`);
  const now = new Date();
  
  if (meetingDateTime <= now) {
    Swal.fire("Error", "Cannot create meeting for past or current date/time. Please select a future date and time.", "error");
    return;
  }

  // ðŸŒ€ Show loading state
  Swal.fire({
    title: "Creating Meeting...",
    html: "Please wait while we connect to Google Calendar â³",
    allowOutsideClick: false,
    didOpen: () => {
      Swal.showLoading();
    }
  });

  try {
    const response = await fetch("/create_meeting_ajax", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ title, date, start_time, duration, timezone, mentor_id })
    });

    const data = await response.json();

    if (response.ok) {
      Swal.fire({
        title: "âœ… Meeting Created!",
        html: `
          <b>${data.title}</b><br>
          <p>${data.start} â†’ ${data.end}</p>
          <p><strong>Time Zone:</strong> ${data.timezone}</p>
          <p>Mentee: ${data.mentee_email}<br>Mentor: ${data.mentor_email}</p>
          <a href="${data.meet_link}" target="_blank">${data.meet_link}</a>
        `,
        icon: "success",
        confirmButtonText: "OK"
      });
    } else {
      Swal.fire("Error", data.error || "Something went wrong!", "error");
    }

  } catch (error) {
    Swal.fire("Error", "Network or server issue!", "error");
    console.error(error);
  }
}

// Set minimum date to today
document.addEventListener('DOMContentLoaded', function() {
  const dateInput = document.getElementById('date');
  const today = new Date().toISOString().split('T')[0];
  dateInput.min = today;
  
  // Auto-detect and pre-select user's timezone
  const timezoneSelect = document.getElementById('timezone');
  const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
  
  // Try to match the detected timezone with one of our options
  const options = timezoneSelect.options;
  for (let i = 0; i < options.length; i++) {
    if (options[i].value === userTimezone) {
      timezoneSelect.selectedIndex = i;
      break;
    }
  }
  
  // If no exact match found, default to Asia/Kolkata for Indian users
  if (!timezoneSelect.value && userTimezone.includes('Asia/Calcutta')) {
    timezoneSelect.value = 'Asia/Kolkata';
  }
});
</script>

{% endblock %}
