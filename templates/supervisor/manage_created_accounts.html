{% extends "base2.html" %}
{% block title %}Manage Created Accounts{% endblock %}
{% block user %}Manage Accounts{% endblock %}

{% block Sidebar %}
    <a href="{{ url_for('supervisordashboard')}}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">ğŸ“Š Dashboard</a>
    <a href="{{ url_for('create_account')}}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">â• Create Account</a>
    <a href="{{ url_for('manage_created_accounts')}}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 bg-gray-100">ğŸ‘¥ Manage Accounts</a>
    <a href="{{ url_for('manage_users_passwords')}}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">ğŸ” Manage Passwords</a>
    <a href="{{ url_for('logout')}}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">ğŸšª Sign out</a>
{% endblock %}

{% block content %}
<!-- Back Button -->
{% include 'components/back_button.html' with context %}

<div class="max-w-6xl mx-auto mt-8 p-6">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ‘¥ Manage Created Accounts</h1>
        <p class="text-gray-600">Total Accounts: <strong>{{ total_accounts }}</strong></p>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="mb-4 p-4 rounded-lg {% if category == 'error' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Search and Filter Section -->
    <div class="mb-8 p-6 bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-gray-700 font-semibold mb-2">ğŸ” Search by Name or Email</label>
                <input type="text" id="searchInput" placeholder="Enter name or email..." class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" onkeyup="filterAccounts()">
            </div>
            
            <div>
                <label class="block text-gray-700 font-semibold mb-2">ğŸ“‹ Filter by Type</label>
                <select id="typeFilter" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" onchange="filterAccounts()">
                    <option value="">All Types</option>
                    <option value="mentor">ğŸ‘¨â€ğŸ« Mentors</option>
                    <option value="mentee">ğŸ‘¨â€ğŸ“ Mentees</option>
                    <option value="institution">ğŸ¢ Institution Admins</option>
                </select>
            </div>

            <div>
                <label class="block text-gray-700 font-semibold mb-2">ğŸ›ï¸ Filter by Institution</label>
                <select id="institutionFilter" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" onchange="filterAccounts()">
                    <option value="">All Institutions</option>
                    {% set institutions_list = [] %}
                    {% for mentor in mentors %}
                        {% if mentor.institution and mentor.institution not in institutions_list %}
                            {% set _ = institutions_list.append(mentor.institution) %}
                            <option value="{{ mentor.institution }}">{{ mentor.institution }}</option>
                        {% endif %}
                    {% endfor %}
                    {% for mentee in mentees %}
                        {% if mentee.institution and mentee.institution not in institutions_list %}
                            {% set _ = institutions_list.append(mentee.institution) %}
                            <option value="{{ mentee.institution }}">{{ mentee.institution }}</option>
                        {% endif %}
                    {% endfor %}
                    {% for institution in institutions %}
                        {% if institution.institution and institution.institution not in institutions_list %}
                            {% set _ = institutions_list.append(institution.institution) %}
                            <option value="{{ institution.institution }}">{{ institution.institution }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="mt-4 flex gap-2">
            <button onclick="filterAccounts()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition">
                <i class="fas fa-search mr-2"></i>Search
            </button>
            <button onclick="resetFilters()" class="px-6 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500 font-semibold transition">
                <i class="fas fa-redo mr-2"></i>Reset
            </button>
        </div>
    </div>

    <!-- Mentors Section -->
    <div class="mb-8">
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4 rounded">
            <h2 class="text-2xl font-bold text-blue-800">ğŸ‘¨â€ğŸ« Mentors (<span id="mentorCount">{{ mentors|length }}</span>)</h2>
        </div>
        {% if mentors %}
        <div class="overflow-x-auto">
            <table class="w-full border-collapse">
                <thead>
                    <tr class="bg-blue-100">
                        <th class="border p-3 text-left">Name</th>
                        <th class="border p-3 text-left">Email</th>
                        <th class="border p-3 text-left">Institution</th>
                        <th class="border p-3 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="mentorTable">
                    {% for mentor in mentors %}
                    <tr class="hover:bg-gray-50 account-row" data-type="mentor" data-name="{{ mentor.name.lower() }}" data-email="{{ mentor.email.lower() }}" data-institution="{{ (mentor.institution or '').lower() }}">
                        <td class="border p-3">{{ mentor.name }}</td>
                        <td class="border p-3">{{ mentor.email }}</td>
                        <td class="border p-3">{{ mentor.institution or 'N/A' }}</td>
                        <td class="border p-3 text-center">
                            <div class="flex gap-2 justify-center">
                                <a href="{{ url_for('edit_user', user_id=mentor.id) }}" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm inline-block">
                                    <i class="fas fa-edit mr-1"></i>Edit
                                </a>
                                <a href="{{ url_for('reset_user_password', user_id=mentor.id) }}" class="px-3 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm inline-block">
                                    <i class="fas fa-key mr-1"></i>Password
                                </a>
                                <form method="POST" action="{{ url_for('delete_user', user_id=mentor.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this user? This action cannot be undone.');">
                                    <button type="submit" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                                        <i class="fas fa-trash mr-1"></i>Delete
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-gray-500 p-4">No mentors created yet.</p>
        {% endif %}
    </div>

    <!-- Mentees Section -->
    <div class="mb-8">
        <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-4 rounded">
            <h2 class="text-2xl font-bold text-green-800">ğŸ‘¨â€ğŸ“ Mentees (<span id="menteeCount">{{ mentees|length }}</span>)</h2>
        </div>
        {% if mentees %}
        <div class="overflow-x-auto">
            <table class="w-full border-collapse">
                <thead>
                    <tr class="bg-green-100">
                        <th class="border p-3 text-left">Name</th>
                        <th class="border p-3 text-left">Email</th>
                        <th class="border p-3 text-left">Institution</th>
                        <th class="border p-3 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="menteeTable">
                    {% for mentee in mentees %}
                    <tr class="hover:bg-gray-50 account-row" data-type="mentee" data-name="{{ mentee.name.lower() }}" data-email="{{ mentee.email.lower() }}" data-institution="{{ (mentee.institution or '').lower() }}">
                        <td class="border p-3">{{ mentee.name }}</td>
                        <td class="border p-3">{{ mentee.email }}</td>
                        <td class="border p-3">{{ mentee.institution or 'N/A' }}</td>
                        <td class="border p-3 text-center">
                            <div class="flex gap-2 justify-center">
                                <a href="{{ url_for('edit_user', user_id=mentee.id) }}" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm inline-block">
                                    <i class="fas fa-edit mr-1"></i>Edit
                                </a>
                                <a href="{{ url_for('reset_user_password', user_id=mentee.id) }}" class="px-3 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm inline-block">
                                    <i class="fas fa-key mr-1"></i>Password
                                </a>
                                <form method="POST" action="{{ url_for('delete_user', user_id=mentee.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this user? This action cannot be undone.');">
                                    <button type="submit" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                                        <i class="fas fa-trash mr-1"></i>Delete
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-gray-500 p-4">No mentees created yet.</p>
        {% endif %}
    </div>

    <!-- Institutions Section -->
    <div class="mb-8">
        <div class="bg-purple-50 border-l-4 border-purple-500 p-4 mb-4 rounded">
            <h2 class="text-2xl font-bold text-purple-800">ğŸ¢ Institution Admins ({{ institutions|length }})</h2>
        </div>
        {% if institutions %}
        <div class="overflow-x-auto">
            <table class="w-full border-collapse">
                <thead>
                    <tr class="bg-purple-100">
                        <th class="border p-3 text-left">Name</th>
                        <th class="border p-3 text-left">Email</th>
                        <th class="border p-3 text-left">Institution</th>
                        <th class="border p-3 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for institution in institutions %}
                    <tr class="hover:bg-gray-50">
                        <td class="border p-3">{{ institution.name }}</td>
                        <td class="border p-3">{{ institution.email }}</td>
                        <td class="border p-3">{{ institution.institution or 'N/A' }}</td>
                        <td class="border p-3 text-center">
                            <div class="flex gap-2 justify-center">
                                <a href="{{ url_for('edit_user', user_id=institution.id) }}" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm inline-block">
                                    <i class="fas fa-edit mr-1"></i>Edit
                                </a>
                                <a href="{{ url_for('reset_user_password', user_id=institution.id) }}" class="px-3 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm inline-block">
                                    <i class="fas fa-key mr-1"></i>Password
                                </a>
                                <form method="POST" action="{{ url_for('delete_user', user_id=institution.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this user? This action cannot be undone.');">
                                    <button type="submit" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                                        <i class="fas fa-trash mr-1"></i>Delete
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-gray-500 p-4">No institution admins created yet.</p>
        {% endif %}
    </div>

    <div class="mt-8 p-4 bg-blue-50 border-l-4 border-blue-400 rounded">
        <p class="text-blue-800"><strong>â„¹ï¸ Info:</strong> You can reset passwords for any created account using the "Reset Password" button.</p>
    </div>
</div>

<script>
function filterAccounts() {
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    const typeFilter = document.getElementById('typeFilter').value.toLowerCase();
    const institutionFilter = document.getElementById('institutionFilter').value.toLowerCase();
    
    const rows = document.querySelectorAll('.account-row');
    let mentorCount = 0;
    let menteeCount = 0;
    
    rows.forEach(row => {
        const name = row.getAttribute('data-name');
        const email = row.getAttribute('data-email');
        const type = row.getAttribute('data-type');
        const institution = row.getAttribute('data-institution');
        
        // Check if row matches all filters
        const matchesSearch = name.includes(searchInput) || email.includes(searchInput);
        const matchesType = !typeFilter || type === typeFilter;
        const matchesInstitution = !institutionFilter || institution === institutionFilter;
        
        if (matchesSearch && matchesType && matchesInstitution) {
            row.style.display = '';
            if (type === 'mentor') mentorCount++;
            if (type === 'mentee') menteeCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update counts
    document.getElementById('mentorCount').textContent = mentorCount;
    document.getElementById('menteeCount').textContent = menteeCount;
}

function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('typeFilter').value = '';
    document.getElementById('institutionFilter').value = '';
    
    const rows = document.querySelectorAll('.account-row');
    rows.forEach(row => row.style.display = '');
    
    // Reset counts
    const mentorCount = document.querySelectorAll('.account-row[data-type="mentor"]').length;
    const menteeCount = document.querySelectorAll('.account-row[data-type="mentee"]').length;
    document.getElementById('mentorCount').textContent = mentorCount;
    document.getElementById('menteeCount').textContent = menteeCount;
}
</script>
{% endblock %}
